<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í˜¼ë°¥ëŸ¬ Â· ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="style.css?v=17" />
    <style>
        .post-card {
            background: #0e1322;
            border: 1px solid #22283a;
            border-radius: 12px;
            padding: 14px;
            margin-top: 12px
        }

        .post-title {
            font-weight: 800;
            font-size: 16px;
            margin: 0 0 4px 0
        }

        .post-meta {
            font-size: 12px;
            color: #9aa0a6;
            margin: 4px 0 8px 0
        }

        .post-body {
            white-space: pre-wrap;
            line-height: 1.5
        }

        .row-wrap {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .muted-sm {
            color: #9aa0a6;
            font-size: 12px
        }

        /* âœ… ê¸€ì“°ê¸° ìµëª… ì²´í¬: ì™¼ìª½ ë¶™ì´ê³  ê°€ë¡œ ìœ ì§€ */
        .anon-wrap {
            display: inline-flex; /* ë¸”ë¡ ì „ì²´í­ì´ ì•„ë‹ˆë¼ ë‚´ìš©ë§Œ */
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            justify-content: flex-start;
            white-space: nowrap; /* 'ìµëª…' ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

            .anon-wrap input {
                margin: 0
            }
        /* ê¸°ë³¸ ì¢Œìš°ë§ˆì§„ ì œê±° */

        /* âœ… ëŒ“ê¸€ UI */
        .comment-wrap {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #2a3145;
        }

        .comment-item {
            padding: 8px 10px;
            border: 1px solid #22283a;
            background: #0c1220;
            border-radius: 10px;
            margin-top: 8px;
        }

        .comment-meta {
            font-size: 11px;
            color: #9aa0a6;
            margin-bottom: 4px
        }

        .comment-form {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
        }
            /* ê°€ë¡œ ê³ ì • */
            .comment-form .c-text {
                flex: 1 1 240px;
            }

            .comment-form .c-anon-label {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                white-space: nowrap; /* 'ìµëª…' ê°€ë¡œ ìœ ì§€ */
            }

        /* í™”ë©´ì´ ì•„ì£¼ ì¢ì„ ë•Œë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆ í—ˆìš© */
        @media (max-width: 380px) {
            .comment-form {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="header" style="margin:0"><div class="logo">ğŸš</div><h1 class="title">í˜¼ë°¥ëŸ¬ Â· ì»¤ë®¤ë‹ˆí‹°</h1></div>
            <div class="row-wrap"><a class="link-btn" href="match.html">ë§¤ì¹­</a><a class="link-btn" href="profile.html">í”„ë¡œí•„</a><a class="link-btn" href="index.html">í™ˆ</a></div>
        </div>

        <div class="card">
            <h2 class="title" style="font-size:18px;margin-top:0">ê²Œì‹œê¸€ ì“°ê¸°</h2>
            <label>ì œëª©</label>
            <input id="title" type="text" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ì ì‹¬ í˜¼ë°¥ í›„ê¸°" maxlength="120" />
            <label>ë‚´ìš©</label>
            <textarea id="body" rows="6" placeholder="ì˜ˆ: ì¶”ì²œ ì‹ë‹¹/ë©”ë‰´/ì‹œê°„ëŒ€ ë“± ììœ ë¡­ê²Œ"></textarea>

            <!-- âœ… ì™¼ìª½ì— ê°€ë¡œë¡œ 'ìµëª…' -->
            <label class="anon-wrap"><input id="anon" type="checkbox" /><span class="muted-sm">ìµëª…</span></label>

            <div class="row" style="margin-top:8px">
                <button id="postBtn" class="btn" style="width:auto;min-width:120px">ë“±ë¡</button>
                <span id="postMsg" class="status"></span>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="topbar" style="margin-bottom:0">
                <h2 class="title" style="font-size:18px;margin:0">ìµœì‹  ê¸€</h2>
                <span class="muted-sm" id="countTxt"></span>
            </div>
            <div id="list"></div>
            <button id="moreBtn" class="btn secondary" style="margin-top:12px;display:none">ë” ë³´ê¸°</button>
        </div>
    </div>

    <script src="config.js?v=26"></script>
    <script type="module" src="./firebase.js?v=26"></script>
    <script type="module">
        const $ = (s) => document.querySelector(s);
        const list = $("#list"), moreBtn = $("#moreBtn"), countTxt = $("#countTxt"), postBtn = $("#postBtn"),
            postMsg = $("#postMsg"), titleEl = $("#title"), bodyEl = $("#body"), anonEl = $("#anon");

        const esc = (s) => (s || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m]));

        if (window.fbReady) await window.fbReady;
        await window.fb.requireAuth();
        const cu = window.fb.auth.currentUser;
        if (!cu || cu.isAnonymous) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = "login.html"; throw new Error("anonymous session"); }

        const MY_UID = cu.uid;
        const MY_EMAIL = (cu.email || "").toLowerCase();
        const IS_ADMIN = window.fb.isAdminEmail?.(MY_EMAIL) === true;

        function canEditOrDelete(post) {
            const byUid = post.authorUid && post.authorUid === MY_UID;
            const byEmail = (post.authorEmail || "").toLowerCase() === MY_EMAIL;
            return IS_ADMIN || byUid || byEmail;
        }

        /* ===== ëŒ“ê¸€ ë Œë”ë§ ìœ í‹¸ ===== */
        function renderCommentItem(c, { canManage, onDelete }) {
            const div = document.createElement("div");
            div.className = "comment-item";
            const who = c.authorDisplay || (c.authorEmail ? c.authorEmail.split("@")[0] : "ìµëª…");
            const when = c.createdAt?.toDate ? c.createdAt.toDate().toLocaleString() : "";
            div.innerHTML = `
                    <div class="comment-meta">${esc(who)} Â· ${when}</div>
                    <div class="comment-text">${esc(c.text || "")}</div>
                `;
            if (canManage) {
                const btn = document.createElement("button");
                btn.textContent = "ì‚­ì œ";
                btn.className = "link-btn";
                btn.style.borderColor = "#ef4444"; btn.style.color = "#ef4444"; btn.style.marginTop = "6px";
                btn.addEventListener("click", async () => { if (confirm("ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) await onDelete().catch(e => alert("ì‚­ì œ ì‹¤íŒ¨: " + (e.message || e))); });
                div.appendChild(btn);
            }
            return div;
        }

        async function renderCommentsBlock(post, wrap) {
            const block = document.createElement("div");
            block.className = "comment-wrap";
            block.innerHTML = `
                    <div class="muted-sm" style="margin-bottom:6px">ëŒ“ê¸€</div>
                    <div class="comment-list"></div>
                    <div class="comment-form">
                        <input class="c-text" type="text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" />
                        <label class="c-anon-label"><input type="checkbox" class="c-anon" /> <span class="muted-sm">ìµëª…</span></label>
                        <button class="btn" style="width:auto;min-width:88px">ë“±ë¡</button>
                    </div>
                    <p class="c-msg status"></p>
                `;
            wrap.appendChild(block);

            const listEl = block.querySelector(".comment-list");
            const textEl = block.querySelector(".c-text");
            const anonChk = block.querySelector(".c-anon");
            const btnEl = block.querySelector(".btn");
            const msgEl = block.querySelector(".c-msg");

            async function reload() {
                listEl.innerHTML = "";
                const items = await window.fb.listComments(post.id, { take: 50 }).catch(() => []);
                (items || []).forEach(c => {
                    const canManage = IS_ADMIN || (c.authorUid === MY_UID) || ((c.authorEmail || "").toLowerCase() === MY_EMAIL);
                    const node = renderCommentItem(c, {
                        canManage,
                        onDelete: () => window.fb.deleteComment(post.id, c.id).then(reload)
                    });
                    listEl.appendChild(node);
                });
                if (!listEl.children.length) {
                    const empty = document.createElement("div");
                    empty.className = "muted-sm"; empty.textContent = "ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!";
                    listEl.appendChild(empty);
                }
            }
            await reload();

            btnEl.addEventListener("click", async () => {
                try {
                    msgEl.className = "status"; msgEl.textContent = "";
                    const t = (textEl.value || "").trim();
                    if (!t) { msgEl.className = "status err"; msgEl.textContent = "ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."; return; }
                    btnEl.disabled = true;
                    await window.fb.addComment(post.id, { text: t, anonymous: !!anonChk.checked });
                    textEl.value = ""; anonChk.checked = false;
                    msgEl.className = "status ok"; msgEl.textContent = "ë“±ë¡ ì™„ë£Œ!";
                    await reload();
                } catch (e) {
                    msgEl.className = "status err"; msgEl.textContent = "ë“±ë¡ ì‹¤íŒ¨: " + (e.message || e);
                } finally {
                    btnEl.disabled = false;
                }
            });
        }
        /* ===== ëŒ“ê¸€ ìœ í‹¸ ë ===== */

        function renderPostCard(p) {
            const wrap = document.createElement("div");
            wrap.className = "post-card";
            const display = p.authorDisplay || (p.authorEmail ? p.authorEmail.split("@")[0] : "ìµëª…");

            wrap.innerHTML = `
                    <h3 class="post-title">${esc(p.title)}</h3>
                    <div class="post-meta">${esc(display)} Â· ${p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : ""}</div>
                    <div class="post-body">${esc(p.body)}</div>
                    <div class="row" style="gap:8px; margin-top:8px"></div>
                `;
            const row = wrap.querySelector(".row");
            if (canEditOrDelete(p)) {
                const editBtn = document.createElement("button");
                editBtn.className = "link-btn"; editBtn.textContent = "ìˆ˜ì •";
                editBtn.style.borderColor = "var(--accent)"; editBtn.style.color = "var(--accent)";
                editBtn.addEventListener("click", async () => {
                    const nt = prompt("ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", p.title ?? ""); if (nt == null) return;
                    const nb = prompt("ìƒˆ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”", p.body ?? ""); if (nb == null) return;
                    try {
                        await window.fb.updatePost(p.id, { title: nt, body: nb });
                        p.title = nt; p.body = nb;
                        wrap.querySelector(".post-title").textContent = nt;
                        wrap.querySelector(".post-body").textContent = nb;
                    } catch (e) { alert("ìˆ˜ì • ì‹¤íŒ¨: " + (e.message || e)); }
                });
                row.appendChild(editBtn);

                const delBtn = document.createElement("button");
                delBtn.textContent = "ì‚­ì œ"; delBtn.className = "link-btn";
                delBtn.style.borderColor = "#ef4444"; delBtn.style.color = "#ef4444";
                delBtn.addEventListener("click", async () => {
                    if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
                    try { await window.fb.deletePost(p.id); wrap.remove(); const left = list.querySelectorAll(".post-card").length; countTxt.textContent = left ? `ì´ ${left}ê°œ` : ""; }
                    catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + (e.message || e)); }
                });
                row.appendChild(delBtn);
            }

            /* âœ… ëŒ“ê¸€ ë¸”ë¡ ë¶€ì°© */
            renderCommentsBlock(p, wrap);

            list.prepend(wrap);
        }

        postBtn?.addEventListener("click", async () => {
            try {
                postMsg.className = "status"; postMsg.textContent = "";
                const title = (titleEl.value || "").trim(); const body = (bodyEl.value || "").trim();
                const anonymous = !!anonEl.checked;
                if (!title) { postMsg.className = "status err"; postMsg.textContent = "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”."; return; }
                postBtn.disabled = true;
                await window.fb.createPost({ title, body, anonymous });
                titleEl.value = ""; bodyEl.value = ""; anonEl.checked = false;
                postMsg.className = "status ok"; postMsg.textContent = "ë“±ë¡ ì™„ë£Œ!";
                list.innerHTML = ""; await loadMore();
            } catch (e) {
                postMsg.className = "status err"; postMsg.textContent = "ë“±ë¡ ì‹¤íŒ¨: " + (e.message || e);
            } finally { postBtn.disabled = false; }
        });

        async function loadMore() {
            try {
                const items = await window.fb.listPosts({ take: 20 }) || [];
                (Array.isArray(items) ? items : (items.items || [])).forEach(renderPostCard);
                moreBtn.style.display = "none";
                const n = list.querySelectorAll(".post-card").length;
                countTxt.textContent = n ? `ì´ ${n}ê°œ` : "";
            } catch (e) {
                console.error(e);
                postMsg.className = "status err";
                postMsg.textContent = "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.";
            }
        }
        await loadMore();
    </script>
</body>
</html>
