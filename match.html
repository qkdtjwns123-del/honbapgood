<!-- filename: match.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>혼밥러 · 매칭</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1 class="title">🍚 혼밥러 · 매칭</h1>
            <p class="muted" style="margin-top:4px">“혼밥러 찾기”를 누르면 대기열에 들어가고, 매칭되면 “수락/거절 → 채팅 시작(Y/n)” 절차를 진행합니다.</p>
        </header>

        <div class="card" style="max-width:560px">
            <div id="filters" class="row" style="gap:16px; flex-wrap:wrap; margin-bottom:12px">
                <label class="chip"><input id="yearSame" type="checkbox" /> 학번 같게</label>
                <label class="chip"><input id="majorSame" type="checkbox" /> 학과 같게</label>
                <label class="chip"><input id="ageSame" type="checkbox" /> 나이 같게</label>
                <label class="chip"><input id="genderSame" type="checkbox" /> 성별 같게</label>
                <label class="chip"><input id="freeOverlap" type="checkbox" /> 공강 겹침 우선</label>
                <label class="chip"><input id="onlineOnly" type="checkbox" /> 동시접속만</label>
            </div>

            <div class="row" style="gap:12px; margin-bottom:8px">
                <button id="startBtn" class="btn outline">혼밥러 찾기</button>
                <button id="leaveBtn" class="btn outline">나가기</button>
                <button id="reopenBtn" class="btn outline" style="display:none">채팅방 열기</button>
            </div>

            <p id="status" class="muted" style="min-height:20px"></p>

            <div class="row" style="gap:8px; margin-top:8px">
                <a class="btn outline" href="community.html">커뮤니티</a>
                <a class="btn outline" href="profile.html">프로필</a>
                <a class="btn outline" href="index.html">홈</a>
                <a class="btn outline" href="bot.html">봇</a>
            </div>
        </div>
    </div>

    <script type="module">
        const $ = id => document.getElementById(id);
        const say = (m, ok = true) => { const el = $('status'); el.textContent = m || ''; el.style.color = ok ? 'var(--text-muted,#9fb7d0)' : '#ff6b6b'; };

        async function ensureFbReady(timeoutMs = 8000) {
            if (window.fb) return window.fb;
            const readyP = (window.fbReady && typeof window.fbReady.then === 'function') ? window.fbReady : new Promise((resolve, reject) => {
                const st = Date.now();
                const iv = setInterval(() => { if (window.fb) { clearInterval(iv); resolve(window.fb); } if (Date.now() - st > timeoutMs) { clearInterval(iv); reject(new Error('firebase 로더가 준비되지 않았어요.')); } }, 100);
            });
            const timeoutP = new Promise((_, rej) => setTimeout(() => rej(new Error('firebase 로더가 준비되지 않았어요.')), timeoutMs));
            return await Promise.race([readyP, timeoutP]);
        }

        const lastRoomId = localStorage.getItem('lastRoomId');
        if (lastRoomId) { const b = $('reopenBtn'); b.style.display = 'inline-block'; b.addEventListener('click', () => location.href = `chat.html?room=${encodeURIComponent(lastRoomId)}`); }

        let finding = false, cancelRequested = false;
        const filterIds = ['yearSame', 'majorSame', 'ageSame', 'genderSame', 'freeOverlap', 'onlineOnly'];
        const setFiltersDisabled = d => { const box = $('filters'); box?.setAttribute('aria-disabled', d ? 'true' : 'false'); filterIds.forEach(id => { const el = $(id); if (el) el.disabled = d; }); };
        const setFindingUI = on => { const s = $('startBtn'); s.classList.toggle('loading', on); s.textContent = on ? '매칭 중' : '혼밥러 찾기'; s.disabled = on; setFiltersDisabled(on); };
        const checkCancelled = () => { if (cancelRequested) { say('대기열에서 나갔어요.'); return true; } return false; };

        $('startBtn').addEventListener('click', onStart);
        $('leaveBtn').addEventListener('click', onLeave);
        window.addEventListener('beforeunload', async () => { try { const fb = await ensureFbReady(500); await fb.cancelMatching(); } catch { } });
        document.addEventListener('visibilitychange', async () => { if (document.visibilityState === 'hidden') { try { const fb = await ensureFbReady(500); await fb.markLeaving(); } catch { } } });

        async function onStart() {
            if (finding) return;
            finding = true; cancelRequested = false; setFindingUI(true); say('대기열에 등록했습니다. 매칭 중…');

            try {
                const fb = await ensureFbReady();
                const me = (await fb.requireAuth())?.uid;

                const opts = {
                    yearSame: $('yearSame').checked, majorSame: $('majorSame').checked,
                    ageSame: $('ageSame').checked, genderSame: $('genderSame').checked,
                    freeOverlap: $('freeOverlap').checked, onlineOnly: $('onlineOnly').checked,
                };
                const { id: roomId } = await fb.startMatching(opts);
                if (checkCancelled()) return cleanup(true, fb);

                // 자동 수락 시도
                try { await fb.acceptMatch(roomId); } catch { }

                say('매칭 중… (상대 수락 대기)');
                const { accepted, declinedBy } = await fb.readyToAccept(roomId, 30);
                if (checkCancelled()) return cleanup(true, fb);

                if (!accepted) {
                    if (declinedBy === me) {
                        await fb.applyPenalty();                 // 내가 취소 → 패널티
                        say('취소하여 패널티 1회가 부여되었습니다.', false);
                    } else {
                        say('상대방이 채팅을 거절했습니다.', false);  // 상대 취소 → 안내만
                    }
                    return;
                }

                // 시작 여부 묻기
                say('매칭 성공! "채팅 시작(Y/n)" 단계로 넘어갑니다.');
                const yes = window.confirm('채팅을 시작 하시겠습니까?');
                if (checkCancelled()) return cleanup(true, fb);

                if (yes) await fb.startYes(roomId);
                else await fb.startNo(roomId);   // 여기서 즉시 startDeclined + 기록

                say('매칭 중… (상대 시작 여부 확인)');
                const { go, declinedBy: startDeclinedBy } = await fb.readyToChat(roomId, 30);
                if (checkCancelled()) return cleanup(true, fb);

                if (go) {
                    localStorage.setItem('lastRoomId', roomId);
                    say('채팅방으로 이동합니다…');
                    await fb.gotoRoom(roomId);
                } else {
                    if (startDeclinedBy === me) {
                        await fb.applyPenalty();                       // 내가 시작 거절 → 패널티
                        say('채팅 시작을 거절하여 패널티 1회가 부여되었습니다.', false);
                    } else {
                        say('상대방이 채팅을 거절했습니다.', false);   // 상대가 거절
                    }
                }
            } catch (e) {
                console.error(e); say('시작 실패: ' + (e?.message || e), false);
            } finally { cleanup(); }
        }

        async function onLeave() {
            cancelRequested = true; finding = false; setFindingUI(false);
            try { const fb = await ensureFbReady(); await fb.cancelMatching(); say('대기열에서 나갔어요.'); }
            catch (e) { console.error(e); say('나가기 실패: ' + (e?.message || e), false); }
        }
        function cleanup(alsoCancel = false, fbInstance = null) {
            if (!cancelRequested) say(''); finding = false; setFindingUI(false);
            if (alsoCancel) { (async () => { try { const fb = fbInstance || await ensureFbReady(); await fb.cancelMatching(); } catch { } })(); }
        }
    </script>

    <!-- 순서 고정: config → firebase (버전 올림으로 캐시 무력화) -->
    <script src="config.js?v=28"></script>
    <script type="module" src="firebase.js?v=33"></script>
</body>
</html>
