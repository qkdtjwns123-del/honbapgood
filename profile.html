<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í˜¼ë°¥ëŸ¬ Â· í”„ë¡œí•„</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <button id="logoutFab" class="btn outline">
        ë¡œê·¸ì•„ì›ƒ
    </button>

    <div class="container">
        <header class="page-header">
            <h1 class="title">ğŸš í˜¼ë°¥ëŸ¬ Â· í”„ë¡œí•„</h1>
        </header>

        <div class="card">
            <p class="muted">ë¡œê·¸ì¸ ì´ë©”ì¼: <span id="loginEmail">(ìµëª…)</span></p>
            <p class="muted">ë§¤ì¹­ ìŠ¤ì½”ì–´: <span id="matchScore">â˜†â˜†â˜† (0íšŒ)</span></p>
            <p class="muted">íŒ¨ë„í‹°: <b id="penaltyInfo">0 / 5</b></p>

            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                <button id="resetMatchScoreBtn"
                        class="btn outline"
                        style="width:auto; display:none;">
                    ë§¤ì¹­ ìŠ¤ì½”ì–´ ì´ˆê¸°í™”
                </button>
                <button id="resetPenaltyBtn"
                        class="btn outline"
                        style="width:auto; display:none;">
                    íŒ¨ë„í‹° ì´ˆê¸°í™”
                </button>
            </div>

            <label class="label">ë‹‰ë„¤ì„</label>
            <input id="nickname" class="input" type="text" placeholder="ì˜ˆ: ì„œì¤€" />

            <label class="label">í•™ë²ˆ(ì…í•™ë…„ë„)</label>
            <input id="year" class="input" type="text" placeholder="ì˜ˆ: 22" />

            <label class="label">ë‚˜ì´(ë§Œ)</label>
            <input id="age" class="input" type="text" placeholder="ì˜ˆ: ë§Œ ë‚˜ì´ ì…ë ¥" />

            <label class="label">ì„±ë³„</label>
            <select id="gender" class="input">
                <option value="">ì„ íƒ</option>
                <option value="ë‚¨">ë‚¨</option>
                <option value="ì—¬">ì—¬</option>
            </select>

            <label class="label">í•™ê³¼</label>
            <input id="major" class="input" type="text" placeholder="ì˜ˆ: ì†Œí”„íŠ¸ì›¨ì–´í•™ë¶€" />

            <label class="label">MBTI</label>
            <input id="mbti" class="input" type="text" placeholder="ì˜ˆ: ISTP" maxlength="4" pattern="[A-Z]{4}" autocomplete="off" />

            <label class="label">í˜¼ë°¥ ë•Œ ì£¼ìš” ì†Œë¹„ ì½˜í…ì¸ </label>
            <input id="content" class="input" type="text" placeholder="ì˜ˆ: ìœ íŠœë¸Œ, ìŒì•…" />

            <label class="label">ê³µê°•ì‹œê°„(ë¬¸ì¥í˜• ì…ë ¥)</label>
            <input id="freeText" class="input" type="text" placeholder="ì˜ˆ: ì›” 12-15, í™” 3-4" />

            <button id="saveBtn" class="btn primary" style="margin-top:16px">í”„ë¡œí•„ ì €ì¥</button>
            <p id="status" class="status muted" style="margin-top:8px;"></p>
        </div>

        <div class="row between" style="margin-top:16px; transform: translateY(-0.7cm);">
            <a class="btn outline" href="community.html" style="width:auto !important; display:inline-flex !important; padding:6px 12px; font-size:14px;">ì»¤ë®¤ë‹ˆí‹°</a>
            <a class="btn outline" href="match.html" style="width:auto !important; display:inline-flex !important; padding:6px 12px; font-size:14px;">ë§¤ì¹­</a>
            <a class="btn outline" href="index.html" style="width:auto !important; display:inline-flex !important; padding:6px 12px; font-size:14px;">í™ˆ</a>
        </div>
    </div>

    <script src="config.js?v=27"></script>
    <script type="module" src="./firebase.js?v=35"></script>

    <script type="module">
        const $ = (id) => document.getElementById(id);

        const year = $('year');
        const age = $('age');
        const gender = $('gender');
        const major = $('major');
        const mbti = $('mbti');
        const content = $('content');
        const freeText = $('freeText');
        const nickname = $('nickname');
        const loginEmail = $('loginEmail');
        const statusEl = $('status');
        const penaltyInfo = $('penaltyInfo');
        const matchScore = $('matchScore');
        const resetPenaltyBtn = $('resetPenaltyBtn');
        const resetMatchScoreBtn = $('resetMatchScoreBtn');

        const fbReady = window.fbReady || Promise.resolve(window.fb);

        // í˜„ì¬ ë¶ˆëŸ¬ì˜¨ í”„ë¡œí•„ ë°ì´í„°ë¥¼ ê¸°ì–µí•´ë‘ì—ˆë‹¤ê°€ ì´ˆê¸°í™” ì‹œ ê°™ì´ ë„˜ê²¨ì¤„ ìš©ë„
        let currentProfile = null;
        let isAdmin = false;

        function setStatus(msg, ok = true) {
            statusEl.textContent = msg || '';
            statusEl.className = 'status ' + (ok ? 'ok' : 'err');
        }

        function renderStars(n) {
            const max = 3;
            const cnt = Math.max(0, Math.min(max, Number(n) || 0));
            let s = '';
            for (let i = 0; i < max; i++) {
                s += i < cnt ? 'â˜…' : 'â˜†';
            }
            return s;
        }

        mbti.addEventListener('input', () => {
            let v = (mbti.value || '').toUpperCase().replace(/[^A-Z]/g, '');
            if (v.length > 4) v = v.slice(0, 4);
            mbti.value = v;
        });
        mbti.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData.getData('text') || '')
                .toUpperCase().replace(/[^A-Z]/g, '').slice(0, 4);
            document.execCommand('insertText', false, text);
        });

        async function boot() {
            const fb = await fbReady;

            // âœ… [ìˆ˜ì •ë¨] ë¡œê·¸ì¸ ê°•ì œ í™•ì¸ ë° 3ì´ˆ ë’¤ ìë™ ë¡œê·¸ì¸ ë°©ì§€
            // requireAuthê°€ ìµëª… ê³„ì •ì„ ìƒì„±í•´ì„œ ë°˜í™˜í•˜ë”ë¼ë„, isAnonymousê°€ trueë©´ ì«“ì•„ëƒ…ë‹ˆë‹¤.
            const u = await fb.requireAuth();
            if (!u || u.isAnonymous) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                location.href = "login.html";
                return; // ì´í›„ ë¡œì§ ì‹¤í–‰ ì¤‘ë‹¨
            }

            // ë¡œê·¸ì¸ ì´ë©”ì¼ + ê´€ë¦¬ì ì—¬ë¶€ íŒë‹¨
            try {
                const savedEmail = sessionStorage.getItem('lastEmail');
                const email = u?.email || savedEmail || '(ìµëª…)';
                loginEmail.textContent = email;

                isAdmin = fb.isAdminEmail?.(email) === true;
                if (isAdmin) {
                    resetPenaltyBtn.style.display = 'inline-flex';
                    resetMatchScoreBtn.style.display = 'inline-flex';
                }
            } catch {
                loginEmail.textContent = '(ìµëª…)';
            }

            // í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸°
            try {
                const data = await fb.loadProfile().catch(() => null);
                currentProfile = data;

                if (data) {
                    if (data.nickname) nickname.value = data.nickname;
                    if (data.year != null) year.value = data.year;
                    if (data.age != null) age.value = data.age;
                    if (data.gender) gender.value = data.gender;
                    if (data.major) major.value = data.major;
                    if (data.mbti) mbti.value = (data.mbti || "").toUpperCase();
                    if (data.content) content.value = data.content;
                    if (typeof data.freeText === 'string') freeText.value = data.freeText;

                    const n = Number(data.penaltyScore || 0);
                    penaltyInfo.textContent = `${n} / 5`;

                    const mc = Number(data.matchCount || 0);
                    const ms = Number(data.matchStars || 0);
                    if (matchScore) {
                        const starsText = renderStars(ms);
                        matchScore.textContent = `${starsText} (${mc}íšŒ)`;
                    }
                } else {
                    if (matchScore) {
                        matchScore.textContent = `${renderStars(0)} (0íšŒ)`;
                    }
                }
            } catch (e) {
                setStatus("í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.", false);
                if (matchScore) {
                    matchScore.textContent = `${renderStars(0)} (0íšŒ)`;
                }
            }

            // âœ… íŒ¨ë„í‹° ì´ˆê¸°í™” ë²„íŠ¼ ë™ì‘
            resetPenaltyBtn?.addEventListener('click', async () => {
                if (!isAdmin) {
                    setStatus('íŒ¨ë„í‹° ì´ˆê¸°í™” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', false);
                    return;
                }
                try {
                    setStatus('');
                    const base = currentProfile || {};
                    await fb.saveProfile({
                        ...base,
                        penaltyScore: 0,
                        penaltyUntil: null
                    });
                    penaltyInfo.textContent = '0 / 5';
                    setStatus('íŒ¨ë„í‹°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
                    currentProfile = {
                        ...base,
                        penaltyScore: 0,
                        penaltyUntil: null
                    };
                } catch (e) {
                    setStatus('íŒ¨ë„í‹° ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (e.message || e), false);
                }
            });

            // âœ… ë§¤ì¹­ ìŠ¤ì½”ì–´ ì´ˆê¸°í™” ë²„íŠ¼ ë™ì‘
            resetMatchScoreBtn?.addEventListener('click', async () => {
                if (!isAdmin) {
                    setStatus('ë§¤ì¹­ ìŠ¤ì½”ì–´ ì´ˆê¸°í™” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', false);
                    return;
                }
                try {
                    setStatus('');
                    await fb.resetMatchScore();
                    if (matchScore) {
                        matchScore.textContent = `${renderStars(0)} (0íšŒ)`;
                    }
                    currentProfile = {
                        ...(currentProfile || {}),
                        matchCount: 0,
                        matchStars: 0
                    };
                    setStatus('ë§¤ì¹­ ìŠ¤ì½”ì–´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
                } catch (e) {
                    setStatus('ë§¤ì¹­ ìŠ¤ì½”ì–´ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (e.message || e), false);
                }
            });

            // âœ… í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ ë™ì‘ (ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ í¬í•¨)
            $('saveBtn').addEventListener('click', async () => {
                setStatus('');

                const fb = await fbReady;
                const newNick = (nickname.value || '').trim();
                const prevNick = (currentProfile?.nickname || '').trim();

                // ë‹‰ë„¤ì„ì´ ìˆê³ , ì´ì „ ê°’ê³¼ ë‹¤ë¥¼ ë•Œë§Œ ì¤‘ë³µ ì²´í¬
                if (newNick && newNick !== prevNick) {
                    try {
                        const ok = await fb.checkNicknameAvailable?.(newNick);
                        if (!ok) {
                            setStatus('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.', false);
                            return;
                        }
                    } catch (e) {
                        setStatus('ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ ì‹¤íŒ¨: ' + (e.message || e), false);
                        return;
                    }
                }

                const payload = {
                    nickname: newNick || null,
                    year: year.value ? Number(year.value) : null,
                    age: age.value ? Number(age.value) : null,
                    gender: gender.value || null,
                    major: major.value || null,
                    mbti: (mbti.value || "").toUpperCase() || null,
                    content: content.value || null,
                    freeText: freeText.value || ''
                };
                try {
                    await fb.saveProfile(payload);
                    setStatus('í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ!', true);
                    currentProfile = {
                        ...(currentProfile || {}),
                        ...payload
                    };
                } catch (e) {
                    setStatus('ì €ì¥ ì‹¤íŒ¨: ' + (e.message || e), false);
                }
            });

            $('logoutFab').addEventListener('click', async () => {
                try { await fb.logout(); } catch { }
                location.href = 'login.html';
            });
        }
        boot();
    </script>
</body>
</html>
