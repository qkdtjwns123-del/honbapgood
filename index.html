<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í˜¼ë°¥ëŸ¬ Â· í™ˆ</title>
    <link rel="stylesheet" href="style.css?v=20" />
    <style>
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 12px
        }

        .tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            border-radius: 14px;
            background: #0e1322;
            border: 1px solid #22283a;
            cursor: pointer;
            text-align: center;
            min-height: 86px
        }

            .tile .emoji {
                font-size: 22px
            }

        .section-title {
            font-size: 18px;
            margin: 0 0 10px 0
        }

        .muted-sm {
            color: #9aa0a6;
            font-size: 12px
        }

        .post-card {
            background: #0e1322;
            border: 1px solid #22283a;
            border-radius: 12px;
            padding: 12px;
            margin-top: 10px
        }

        .post-title {
            font-weight: 800;
            font-size: 15px;
            margin: 0 0 4px 0
        }

        .post-meta {
            color: #9aa0a6;
            font-size: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .row-wrap {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        /* âœ… ì»¤ë®¤ë‹ˆí‹°ì™€ ë™ì¼í•œ ìµëª… ì²´í¬ ìŠ¤íƒ€ì¼ */
        .anon-wrap {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            justify-content: flex-start;
            white-space: nowrap;
        }

            .anon-wrap input {
                margin: 0
            }
    </style>
</head>
<body>

    <button id="logoutFab" class="btn outline" style="position:fixed; right:16px; top:14px; z-index:1000; padding:6px 12px; font-size:14px;">
        ë¡œê·¸ì•„ì›ƒ
    </button>

    <div class="container">
        <div class="header" style="margin-bottom:12px">
            <div class="logo">ğŸš</div>
            <h1 class="title">í˜¼ë°¥ëŸ¬ Â· í™ˆ</h1>
        </div>

        <div class="card">
            <div class="grid-3">
                <a class="tile" href="match.html"><div class="emoji">ğŸš</div><div><b>í˜¼ë°¥ëŸ¬ ë§¤ì¹­</b><div class="muted-sm">ë°”ë¡œ ì‹œì‘</div></div></a>
                <a class="tile" href="community.html"><div class="emoji">ğŸ—¨ï¸</div><div><b>ì»¤ë®¤ë‹ˆí‹°</b><div class="muted-sm">ê¸€/ëŒ“ê¸€/ì¢‹ì•„ìš”</div></div></a>
                <a class="tile" href="profile.html"><div class="emoji">ğŸ‘¤</div><div><b>ë‚´ í”„ë¡œí•„</b><div class="muted-sm">ì •ë³´ ìˆ˜ì •</div></div></a>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <h2 class="section-title">ë¬´ìŠ¨ ìƒê° ì¤‘ì´ì—ìš”?</h2>
            <div class="row"><input id="quickTitle" type="text" placeholder="ì œëª© (ì˜ˆ: ì˜¤ëŠ˜ ì ì‹¬ ì¶”ì²œ)" maxlength="120" /></div>
            <div class="row" style="margin-top:8px">
                <input id="quickBody" type="text" placeholder="ë‚´ìš© í•œ ì¤„ (ì»¤ë®¤ë‹ˆí‹°ì— ì˜¬ë¼ê°€ìš”)" />
                <button id="quickPostBtn" class="btn" style="width:auto;min-width:120px">ë“±ë¡</button>
            </div>

            <!-- âœ… ì»¤ë®¤ë‹ˆí‹°ì™€ ë™ì¼: ì™¼ìª½ ì •ë ¬ + ê°€ë¡œ ë¼ë²¨ 'ìµëª…' -->
            <label class="anon-wrap"><input id="quickAnon" type="checkbox" /><span class="muted-sm">ìµëª…</span></label>

            <p id="quickMsg" class="status"></p>
            <div class="muted-sm">ì „ì²´ ê¸€ì“°ê¸°ëŠ” <a href="community.html">ì»¤ë®¤ë‹ˆí‹°</a>ì—ì„œ í•  ìˆ˜ ìˆì–´ìš”.</div>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="topbar" style="margin-bottom:0">
                <h2 class="section-title" style="margin:0">ìµœì‹  ê¸€</h2>
                <a class="link-btn" href="community.html">ë” ë³´ê¸°</a>
            </div>
            <div id="feed"></div>
        </div>

        <div class="card" style="margin-top:16px">
            <h2 class="section-title">ë‚´ í”„ë¡œí•„</h2>
            <div id="profileBox" class="muted-sm">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div class="nav" style="margin-top:12px"><a class="link-btn" href="profile.html">í”„ë¡œí•„ ìˆ˜ì •</a></div>
        </div>
    </div>

    <script src="config.js?v=26"></script>
    <script type="module" src="./firebase.js?v=26"></script>
    <script type="module">
        const $ = (s) => document.querySelector(s);
        const feed = $("#feed"), quickTitle = $("#quickTitle"), quickBody = $("#quickBody"),
            quickBtn = $("#quickPostBtn"), quickMsg = $("#quickMsg"), profileBox = $("#profileBox"),
            quickAnon = $("#quickAnon");
        const logoutFab = document.getElementById("logoutFab");
        logoutFab?.addEventListener("click", async () => {
            try { if (window.fbReady) await window.fbReady; await window.fb.logout(); } catch { } finally { location.href = "login.html"; }
        });

        if (window.fbReady) await window.fbReady;
        try { await window.fb.requireAuth(); } catch (e) { location.href = "signup.html"; throw e; }

        const cu = window.fb.auth.currentUser;
        const MY_EMAIL = (cu?.email || "").toLowerCase();
        const IS_ADMIN = window.fb.isAdminEmail?.(MY_EMAIL) === true;

        quickBtn.addEventListener("click", async () => {
            try {
                quickMsg.className = "status"; quickMsg.textContent = "";
                const title = (quickTitle.value || "").trim();
                const body = (quickBody.value || "").trim();
                const anonymous = !!quickAnon.checked;
                if (!title) { quickMsg.className = "status err"; quickMsg.textContent = "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”."; return; }
                quickBtn.disabled = true;
                await window.fb.createPost({ title, body, anonymous });
                quickTitle.value = ""; quickBody.value = ""; quickAnon.checked = false;
                quickMsg.className = "status ok"; quickMsg.textContent = "ë“±ë¡ ì™„ë£Œ!";
                feed.innerHTML = ""; await loadFeed();
            } catch (e) {
                quickMsg.className = "status err"; quickMsg.textContent = e?.message || e;
            } finally { quickBtn.disabled = false; }
        });

        function esc(s) { return (s || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m])); }

        async function loadFeed() {
            const items = await window.fb.listPosts({ take: 5 }) || [];
            feed.innerHTML = "";
            (Array.isArray(items) ? items : (items.items || [])).forEach(p => {
                const display = p.authorDisplay || (p.authorEmail ? p.authorEmail.split("@")[0] : "ìµëª…");
                const card = document.createElement("div");
                card.className = "post-card";
                card.innerHTML = `
                        <div class="post-title">${esc(p.title)}</div>
                        <div class="post-meta">
                          <span>${esc(display)}</span><span>Â·</span>
                          <span>${p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : ""}</span>
                          <span>Â·</span><span>ì¢‹ì•„ìš” <b class="likecnt">0</b></span>
                        </div>
                        <div class="muted-sm" style="margin-top:6px">${esc((p.body || "").slice(0, 100))}${(p.body || "").length > 100 ? "â€¦" : ""}</div>
                        <div class="nav" style="margin-top:10px"><a class="link-btn" href="community.html">ëŒ“ê¸€/ìƒì„¸ ë³´ê¸°</a></div>`;
                const canManage = IS_ADMIN || ((p.authorEmail || "").toLowerCase() === MY_EMAIL);
                if (canManage) {
                    const nav = card.querySelector(".nav");
                    const editBtn = document.createElement("button");
                    editBtn.textContent = "ìˆ˜ì •"; editBtn.className = "link-btn";
                    editBtn.style.borderColor = "var(--accent)"; editBtn.style.color = "var(--accent)";
                    editBtn.addEventListener("click", async () => {
                        const nt = prompt("ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", p.title ?? ""); if (nt == null) return;
                        const nb = prompt("ìƒˆ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”", p.body ?? ""); if (nb == null) return;
                        try {
                            await window.fb.updatePost(p.id, { title: nt, body: nb });
                            p.title = nt; p.body = nb;
                            card.querySelector(".post-title").textContent = nt;
                            card.querySelector(".muted-sm").textContent = (nb || "").slice(0, 100) + ((nb || "").length > 100 ? "â€¦" : "");
                        } catch (e) { alert("ìˆ˜ì • ì‹¤íŒ¨: " + (e.message || e)); }
                    });
                    nav.appendChild(editBtn);

                    const delBtn = document.createElement("button");
                    delBtn.textContent = "ì‚­ì œ"; delBtn.className = "link-btn";
                    delBtn.style.borderColor = "#ef4444"; delBtn.style.color = "#ef4444";
                    delBtn.addEventListener("click", async () => {
                        if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
                        try { await window.fb.deletePost(p.id); await loadFeed(); }
                        catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + (e.message || e)); }
                    });
                    nav.appendChild(delBtn);
                }
                feed.appendChild(card);

                const likeEl = card.querySelector(".likecnt");
                const un = window.fb.onLikeCount?.(p.id, (n) => { likeEl.textContent = String(n); });
                window.addEventListener("beforeunload", () => { try { un && un(); } catch { } });
            });

            if (feed.children.length === 0) {
                const div = document.createElement("div");
                div.className = "muted-sm"; div.style.marginTop = "6px"; div.textContent = "ì•„ì§ ê¸€ì´ ì—†ì–´ìš”. ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!";
                feed.appendChild(div);
            }
        }
        await loadFeed();

        // í”„ë¡œí•„ ìš”ì•½
        try {
            const data = await window.fb.loadProfile().catch(() => null);
            const L = [];
            if (data?.nickname) L.push(`ë‹‰ë„¤ì„: ${data.nickname}`);
            if (data?.major) L.push(`í•™ê³¼: ${data.major}`);
            if (data?.year != null) L.push(`í•™ë²ˆ: ${data.year}`);
            if (data?.age != null) L.push(`ë‚˜ì´: ${data.age}`);
            if (data?.gender) L.push(`ì„±ë³„: ${data.gender}`);
            if (data?.mbti) L.push(`MBTI: ${String(data.mbti).toUpperCase()}`);
            if (data?.content) L.push(`ì½˜í…ì¸ : ${data.content}`);
            profileBox.textContent = L.length ? L.join(" Â· ") : "ì•„ì§ í”„ë¡œí•„ ì •ë³´ê°€ ë¹„ì–´ ìˆì–´ìš”.";
        } catch { profileBox.textContent = "í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”."; }
    </script>
</body>
</html>
